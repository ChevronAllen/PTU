<rolltemplate class="sheet-rolltemplate-PTU">
    <table>
        <tr>
            <th colspan="2">{{name}}</th>
        </tr>
        {{#allprops() name effect descr}}
        <tr>
            <td><strong>{{key}}</strong></td>
            <td style="white-space: pre-line;">{{value}}</td>
        </tr>
        {{/allprops() name effect}}
        {{#effect}}
        <tr>
            
            <td colspan="2" style="white-space: pre-line;text-align:left">{{effect}}</td>
        </tr>
        {{/effect}}
        {{#descr}}
        <tr>
            
            <td colspan="2" style="white-space: pre-line;text-align:left">{{descr}}</td>
        </tr>
        {{/descr}}
    </table>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-PTU_Move_AC">
    <table>
        <tr>
            <th colspan="2">{{name}}</th>
        </tr>
        <tr>
            <th colspan="2">{{roll}} &#8805; {{ac}}</th>
        </tr>
        <tr>
            <th colspan="2">Crit on {{crit}}+</th>
        </tr>
    </table>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-PTU_Move_DMG">
    <div class="sheet-header">
        <label>{{name}}</label>
    </div>
    <div>
        <label>DB:<span>{{db}}</span></label>
    </div>
    <div>
        <label>Damage:<span>{{damage}} {{type}}</span></label>
    </div>
</rolltemplate>

<div class="sheet-header" >
    <img src="https://raw.githubusercontent.com/ChevronAllen/PTU/master/Logo.png" style="display:block;margin:0 auto;width:100px">
</div>

<div class="sheet-creature">
    <div class="sheet-btn">
        <input type="radio" name="attr_isTrainer" value="0" checked/>
        <span>Pokemon</span>
    </div>    
    <div class="sheet-btn">
        <input type="radio" name="attr_isTrainer" value="1" />
        <span>Trainer</span>
    </div>    
</div>


<div class="sheet-characterInfo" >
    <input type="hidden" name="attr_isTrainer" class="sheet-creature-swap" value="1"/>
    
    <div class="sheet-row sheet-trainer">
        <div class="sheet-field">
            <input type="text" name="attr_character_name" />
            <span>Name</span>
        </div>
        <div class="sheet-field" style="width:100px">
            <input type="text" name="attr_character_age" />
            <span>Age</span>
        </div>
        <div class="sheet-field" style="width:150px">
            <input type="text" name="attr_character_gender" />
            <span>Gender</span>
        </div>
        <div class="sheet-field" style="width:150px">
            <input type="number" name="attr_character_money"  />
            <span>Money</span>
        </div>
    </div>
    
    <div class="sheet-row sheet-pokemon">
        <div class="sheet-field">
            <input type="text" name="attr_character_name"/>
            <span>Nickname</span>
        </div>
        <div class="sheet-field">
            <input type="text"  name="attr_character_species"/>
            <span>Species</span>
        </div>
        <div class="sheet-field">
            <input type="text" name="attr_character_gender" />
            <span>Gender</span>
        </div>
    </div>
    
    <div class="sheet-row  sheet-pokemon">
        <div class="sheet-field">
            <select name="attr_character_nature">
                <option>Adamant</option>
                <option>Bashful</option>
                <option>Bold</option>
                <option>Brave</option>
                <option>Calm</option>
                <option>Careful</option>
                <option>Composed</option>
                <option>Cuddly</option>
                <option>Curious</option>
                <option>Decisive</option>
                <option>Desperate</option>
                <option>Distracted</option>
                <option>Docile</option>
                <option>Dreamy</option>
                <option>Gentle</option>
                <option>Hardy</option>
                <option>Hasty</option>
                <option>Impish</option>
                <option>Jolly</option>
                <option>Lax</option>
                <option>Lonely</option>
                <option>Mild</option>
                <option>Modest</option>
                <option>Naive</option>
                <option>Naughty</option>
                <option>Patient</option>
                <option>Proud</option>
                <option>Quiet</option>
                <option>Quirky</option>
                <option>Rash</option>
                <option>Relaxed</option>
                <option>Sassy</option>
                <option>Serious</option>
                <option>Skittish</option>
                <option>Stark</option>
                <option>Timid</option>
            </select>
            <span>Nature</span>
        </div>
        
        <div class="sheet-field" style="width:120px">
            <span class="sheet-field" name="attr_character_raisedStat"></span>
            <span>Raised</span>
        </div>
        <div class="sheet-field" style="width:120px">
            <span class="sheet-field" name="attr_character_loweredStat"></span>
            <span>Lowered</span>
        </div>
        <div class="sheet-field" style="width:120px">
            <span class="sheet-field" name="attr_character_likeFlavor"></span>
            <span>Like</span>
        </div>
        <div class="sheet-field" style="width:120px">
            <span class="sheet-field" name="attr_character_dislikeFlavor"></span>
            <span>Dislike</span> 
        </div>
        
    </div>
    
    <div class="sheet-row">
        <div class="sheet-field" style="width:100px">
            <input type="text" name="attr_character_height" />
            <span>Height</span>
        </div>
        <div class="sheet-field" style="width:100px">
            <input type="text" name="attr_character_weight" />
            <span>Weight</span>
        </div>
        <div class="sheet-field" style="width:60px">
            <input type="text" name="attr_character_weightClass" />
            <span>Class</span>
        </div>
    </div>
    
    <div class="sheet-row sheet-background sheet-trainer">
        <input type="hidden" name="attr_background_hide" class="sheet-hide-swap" />
        
        <div class="sheet-row">
            <input type="hidden" name="attr_background_hide" class="sheet-hide-swap" />
            
            <div class="sheet-field">
                <input type="text" name="attr_background" />
                <span>Background Name</span>
            </div>
            
            <div class="sheet-field sheet-hide-a" style="width:200px">
                <input type="text" name="attr_background_adept" />
                <span>Adept Skill (+2)</span>
            </div>
            
            <div class="sheet-field sheet-hide-a" style="width:200px">
                <input type="text" name="attr_background_novice"/>
                <span>Novice Skill (+1)</span>
            </div>
            
            <div class="sheet-collapse-btn">
                <input type="hidden" name="attr_background_hide" class="sheet-hide-swap" value="1"/>
                
                <input type="checkbox" name="attr_background_hide" value="1" />
                <span></span>

            </div>
        </div>
        
        <div class="sheet-row sheet-hide-a">
            <div class="sheet-field " style="width:100%">
                    <input type="text" name="attr_background_pathetic" />
                    <span>Pathetic Skills (-1)</span>
                </div>
        </div>
        
        <div class="sheet-row sheet-hide-a">
            <div class="sheet-field" style="width:100%">
                <textarea name="attr_background_descr"></textarea>
                <span>Description</span>
            </div>
        </div>
    </div>
    
</div>


<div class="sheet-tabs">
    <input type="hidden" name="attr_isTrainer" class="sheet-creature-swap" value="0"/>
    <div class="sheet-tab">
        <input type="radio" name="attr_tab" value="0" checked/>
        <span>Core</span>
    </div>
    <div class="sheet-tab">
        <input type="radio" name="attr_tab" value="1" />
        <span>Skills</span>
    </div>
    <div class="sheet-tab">
        <input type="radio" name="attr_tab" value="2" />
        <span>Features</span>
    </div>
    <div class="sheet-tab">
        <input type="radio" name="attr_tab" value="3" />
        <span>Moves</span>
    </div>
    <div class="sheet-tab">
        <input type="radio" name="attr_tab" value="4" />
        <span>Inventory</span>
    </div>
</div>

<div class="sheet-whisperMode">
    <div class="sheet-btn">
        <input type="radio" name="attr_whisper" value="/w gm" checked/>
        <span>To GM</span>
    </div>
    <div class="sheet-btn">
        <input type="radio" name="attr_whisper" value=" " />
        <span>Public</span></span>
    </div>
</div>

<div class="sheet-body" >
    <input type="hidden" name="attr_isTrainer" class="sheet-creature-swap" value="0"/>
    <input type="hidden" name="attr_tab" class="sheet-tab-swap" value="3" />
    
    <!-- (0) Core -->
    <div class="sheet-page-core" >
        
        <div>
            <!-- Main Stats -->
            <div class="sheet-item">
                <table class="sheet-stats">
                    <tbody>
                        <tr class="sheet-header">
                            <th colspan="6">Stats</th>
                        </tr>
                        <tr class="sheet-header">
                            <th></th>
                            <th>Base</th>
                            <th>Allocated</th>
                            <th>Bonus</th>
                            <th>Stage</th>
                            <th></th>
                        </tr>
                        <tr>
                            <td>HP</td>
                            <td><input type="number" name="attr_stat_hp_base" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_hp_allocated" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_hp_bonus" value="0" /></td>
                            <td></td>
                            <td>
                                <input type="hidden" name="attr_stat_hp" />
                                <div class="sheet-field" style="width:50px">
                                    <span name="attr_stat_hp" class="sheet-field">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Attack</td>
                            <td><input type="number" name="attr_stat_atk_base" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_atk_allocated" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_atk_bonus" value="0"  /></td>
                            <td>
                                <select name="attr_stat_atk_stage" style="width:auto">
                                    <option value="-6" >-6</option>
                                    <option value="-5" >-5</option>
                                    <option value="-4" >-4</option>
                                    <option value="-3" >-3</option>
                                    <option value="-2" >-2</option>
                                    <option value="-1" >-1</option>
                                    <option value="0"  selected>0</option>
                                    <option value="1"  >+1</option>
                                    <option value="2"  >+2</option>
                                    <option value="3"  >+3</option>
                                    <option value="4"  >+4</option>
                                    <option value="5"  >+5</option>
                                    <option value="6"  >+6</option>
                                </select>
                            </td>
                            <td>
                                <input type="hidden" name="attr_stat_atk" />
                                <div class="sheet-field" style="width:50px">
                                    <span name="attr_stat_atk" class="sheet-field">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Defense</td>
                            <td><input type="number" name="attr_stat_def_base" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_def_allocated" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_def_bonus" value="0" /></td>
                            <td>
                                <select name="attr_stat_def_stage" style="width:auto">
                                    <option value="-6" >-6</option>
                                    <option value="-5" >-5</option>
                                    <option value="-4" >-4</option>
                                    <option value="-3" >-3</option>
                                    <option value="-2" >-2</option>
                                    <option value="-1" >-1</option>
                                    <option value="0"  selected>0</option>
                                    <option value="1"  >+1</option>
                                    <option value="2"  >+2</option>
                                    <option value="3"  >+3</option>
                                    <option value="4"  >+4</option>
                                    <option value="5"  >+5</option>
                                    <option value="6"  >+6</option>
                                </select>
                            </td>
                            <td>
                                <input type="hidden" name="attr_stat_def" />
                                <div class="sheet-field" style="width:50px">
                                    <span name="attr_stat_def" class="sheet-field">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Sp.Attack</td>
                            <td><input type="number" name="attr_stat_spatk_base" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_spatk_allocated" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_spatk_bonus" value="0"  /></td>
                            <td>
                                <select name="attr_stat_spatk_stage" style="width:auto">
                                    <option value="-6" >-6</option>
                                    <option value="-5" >-5</option>
                                    <option value="-4" >-4</option>
                                    <option value="-3" >-3</option>
                                    <option value="-2" >-2</option>
                                    <option value="-1" >-1</option>
                                    <option value="0"  selected>0</option>
                                    <option value="1"  >+1</option>
                                    <option value="2"  >+2</option>
                                    <option value="3"  >+3</option>
                                    <option value="4"  >+4</option>
                                    <option value="5"  >+5</option>
                                    <option value="6"  >+6</option>
                                </select>
                            </td>
                            <td>
                                <input type="hidden" name="attr_stat_spatk" />
                                <div class="sheet-field" style="width:50px">
                                    <span name="attr_stat_spatk" class="sheet-field">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Sp.Defense</td>
                            <td><input type="number" name="attr_stat_spdef_base" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_spdef_allocated" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_spdef_bonus" value="0" /></td>
                            <td>
                                <select name="attr_stat_spdef_stage" style="width:auto">
                                    <option value="-6" >-6</option>
                                    <option value="-5" >-5</option>
                                    <option value="-4" >-4</option>
                                    <option value="-3" >-3</option>
                                    <option value="-2" >-2</option>
                                    <option value="-1" >-1</option>
                                    <option value="0"  selected>0</option>
                                    <option value="1"  >+1</option>
                                    <option value="2"  >+2</option>
                                    <option value="3"  >+3</option>
                                    <option value="4"  >+4</option>
                                    <option value="5"  >+5</option>
                                    <option value="6"  >+6</option>
                                </select>
                            </td>
                            <td>
                                <input type="hidden" name="attr_stat_spdef" />
                                <div class="sheet-field" style="width:50px">
                                    <span name="attr_stat_spdef" class="sheet-field">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Speed</td>
                            <td><input type="number" name="attr_stat_speed_base" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_speed_allocated" value="0" min="0" /></td>
                            <td><input type="number" name="attr_stat_speed_bonus" value="0" /></td>
                            <td>
                                <select name="attr_stat_speed_stage" style="width:auto">
                                    <option value="-6" >-6</option>
                                    <option value="-5" >-5</option>
                                    <option value="-4" >-4</option>
                                    <option value="-3" >-3</option>
                                    <option value="-2" >-2</option>
                                    <option value="-1" >-1</option>
                                    <option value="0"  selected>0</option>
                                    <option value="1"  >+1</option>
                                    <option value="2"  >+2</option>
                                    <option value="3"  >+3</option>
                                    <option value="4"  >+4</option>
                                    <option value="5"  >+5</option>
                                    <option value="6"  >+6</option>
                                </select>
                            </td>
                            <td>
                                <input type="hidden" name="attr_stat_speed" />
                                <div class="sheet-field" style="width:50px">
                                    <span name="attr_stat_speed" class="sheet-field">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5">Accuracy</td>
    
                            
                            <td>
                                <select name="attr_stat_accuracy" style="width:auto">
                                    <option value="-6" >-6</option>
                                    <option value="-5" >-5</option>
                                    <option value="-4" >-4</option>
                                    <option value="-3" >-3</option>
                                    <option value="-2" >-2</option>
                                    <option value="-1" >-1</option>
                                    <option value="0"  selected>0</option>
                                    <option value="1"  >+1</option>
                                    <option value="2"  >+2</option>
                                    <option value="3"  >+3</option>
                                    <option value="4"  >+4</option>
                                    <option value="5"  >+5</option>
                                    <option value="6"  >+6</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5">Evasion</td>
    
                            <td>
                                <select name="attr_stat_evasion" style="width:auto">
                                    <option value="-6" >-6</option>
                                    <option value="-5" >-5</option>
                                    <option value="-4" >-4</option>
                                    <option value="-3" >-3</option>
                                    <option value="-2" >-2</option>
                                    <option value="-1" >-1</option>
                                    <option value="0"  selected>0</option>
                                    <option value="1"  >+1</option>
                                    <option value="2"  >+2</option>
                                    <option value="3"  >+3</option>
                                    <option value="4"  >+4</option>
                                    <option value="5"  >+5</option>
                                    <option value="6"  >+6</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">Initiative</td>
    
                            <td><input type="number" name="attr_stat_initiative_bonus" value="0" /></td>
                            <td></td>
                            <td>
                                <input type="hidden" name="attr_stat_initiative" value="0" />
                                <button type="roll" 
                                value="&{template:PTU} {{name= @{character_name}'s Initiative}} {{initiative: [[@{stat_initiative} + @{stat_speed} + [[[[1d20]]/100]] &{tracker}]] }}"></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Evasions -->
            <div class="sheet-item" >
                <table class="sheet-evasions">
                    <tbody>
                        <tr class="sheet-header">
                            <th colspan="6">Evasions</th>
                        </tr>
                        <tr class="sheet-header">
                            <th colspan="3"></th>
                            <th>Bonus</th>
                            <th></th>
                            <th>Current</th>
                        </tr>
                        <tr>
                            <td colspan="2">Physical Evasion</td>
                            <td>+</td>
                            <td>
                                <input type="number" name="attr_evasion_physical_bonus" value="0" />
                            </td>
                            <td>=</td>
                            <td>
                                <div class="sheet-field" >
                                    <span class="sheet-field" name="attr_evasion_physical">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">Special Evasion</td>
                            <td>+</td>
                            <td>
                                <input type="number" name="attr_evasion_special_bonus" value="0" />
                            </td>
                            <td>=</td>
                            <td>
                                <div class="sheet-field" >
                                    <span class="sheet-field" name="attr_evasion_special">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">Speed Evasion</td>
                            <td>+</td>
                            <td>
                                <input type="number" name="attr_evasion_speed_bonus" value="0" />
                            </td>
                            <td>=</td>
                            <td>
                                <div class="sheet-field" >
                                    <span class="sheet-field" name="attr_evasion_speed">0</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Capabilities -->
            <div class="sheet-item" >
                <table class="sheet-capabilities">
                    <tbody>
                        <tr class="sheet-header">
                            <th colspan="6">Capabilities</th>
                        </tr>
                        <tr class="sheet-header">
                            <th colspan="3"></th>
                            <th>Bonus</th>
                            <th></th>
                            <th>Current</th>
                        </tr>
                        <tr>
                            <td colspan="2">Overland</td>
                            <td>+</td>
                            <td><input type="number" name="attr_overland_bonus" value="0" /></td>
                            <td>=</td>
                            <td>
                                <div class="sheet-field" >
                                    <span class="sheet-field" name="attr_overland">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">Swim</td>
                            <td>+</td>
                            <td><input type="number" name="attr_swim_bonus" value="0" /></td>
                            <td>=</td>
                            <td>
                                <div class="sheet-field" >
                                    <span class="sheet-field" name="attr_swim">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">Long Jump</td>
                            <td>+</td>
                            <td><input type="number" name="attr_jumpLong_bonus" value="0" /></td>
                            <td>=</td>
                            <td>
                                <div class="sheet-field" >
                                    <span class="sheet-field" name="attr_jumpLong">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">High Jump</td>
                            <td>+</td>
                            <td><input type="number" name="attr_jumpHigh_bonus" value="0" /></td>
                            <td>=</td>
                            <td>
                                <div class="sheet-field" >
                                    <span class="sheet-field" name="attr_jumpHigh">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">Throw Range</td>
                            <td>+</td>
                            <td><input type="number" name="attr_thrown_bonus" value="0" /></td>
                            <td>=</td>
                            <td>
                                <div class="sheet-field" >
                                    <span class="sheet-field" name="attr_thrown">0</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <fieldset class="repeating_capabilities">
                    <div class="sheet-capabilities-item">
                        <input type="text"   name="attr_cName" placeholder="Capability" />
                        <input type="number" name="attr_cScore" value="0" />
                    </div>
                </fieldset>
            </div>
            
        </div>
        
        <div>
            <!-- Current Status -->
            <div class="sheet-item" style="background-color: #666;">
                <table class="sheet-status">
                    <tbody>
                        <tr class="sheet-header">
                            <th colspan="3" >Status</th>
                        </tr>
                        <tr>
                            <td>Level</td>
                            <td colspan="2">
                                <input type="number" name="attr_level" value="0" min="1" />
                            </td>
                        </tr>
                        <tr>
                            <td>Exp</td>
                            <td>
                                <input type="number" name="attr_exp" value="0" min="0" />
                            </td>
                            <td>
                                <strong>/</strong>
                                <div class="sheet-field" style="width:80px">
                                    <span class="sheet-field" name="attr_exp_max" >0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Temp HP</td>
                            <td colspan="2">
                                <input type="number" name="attr_HP_temp" value="0" min="0" />
                            </td>
                        </tr>
                        <tr>
                            <td>Hit Points</td>
                            <td colspan="2">
                                <input type="number" name="attr_HP" value="0" />
                            </td>
                        </tr>
                        <tr>
                            <td>Max Hit Points</td>
                            <td colspan="2">
                                <input type="hidden" name="attr_HP_max" />
                                <input type="hidden" name="attr_HP_max_current" />
                                
                                <div class="sheet-field" style="width:80px">
                                    <span class="sheet-field" name="attr_HP_max_current"  style="font-size:12pt">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Injuries</td>
                            <td colspan="2">
                                <input type="number" name="attr_injury" value="0" min="0" max="10" />
                            </td>
                        </tr>
                        <tr>
                            
                            <td>AP</td>
                            <td >
                                <div class="sheet-field" style="width:80px">
                                    <span class="sheet-field" name="attr_AP">5</span>
                                    <span style="text-align: left;">Current</span>
                                </div>
                            </td>
                            <td >
                                <div class="sheet-field" style="width:80px">
                                    <span class="sheet-field" name="attr_AP_max">5</span>
                                    <span style="text-align: left;">Max</span>
                                </div>
                            </td>
                            <input type="hidden" name="attr_AP" />
                            <input type="hidden" name="attr_AP_max" />
                        </tr>
                        <tr class="sheet-header">
                            <th colspan="3">AP Used</th>
                        </tr>
                    </tbody>
                </table>
                
                <fieldset class="repeating_AP">
                    <div class="sheet-AP-item">
                        <select name="attr_apType" style="width:auto">
                            <option >Spent</option>
                            <option >Drained</option>
                            <option >Bound</option>
                        </select>
                        <input type="number" name="attr_apCost" min="0" placeholder="cost" />
                        <input type="text" name="attr_apName" style="width:160px" placeholder="Ability Name / Reason"/>
                    </div>
                </fieldset>
            </div>
            
            <!-- HP Markers -->
            <div class="sheet-item" >
                <table class="sheet-markers">
                    <tbody>
                        <tr class="sheet-header">
                            <th colspan="4">HP Marker</th>
                        </tr>
                        <tr>
                            <td class="sheet-header">75%</td>
                            <td>
                                <div class="sheet-field">
                                    <span class="sheet-field" name="attr_hpMarker_3_4">0</span>
                                </div>
                            </td>
                            <td class="sheet-header">1/6</td>
                            <td>
                                <div class="sheet-field">
                                    <span class="sheet-field" name="attr_hpMarker_1_6">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-header">50%</td>
                            <td>
                                <div class="sheet-field">
                                    <span class="sheet-field" name="attr_hpMarker_1_2">0</span>
                                </div>
                            </td>
                            <td class="sheet-header">1/8</td>
                            <td>
                                <div class="sheet-field">
                                    <span class="sheet-field" name="attr_hpMarker_1_8">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-header">1/3</td>
                            <td>
                                <div class="sheet-field">
                                    <span class="sheet-field" name="attr_hpMarker_1_4">0</span>
                                </div>
                            </td>
                            <td class="sheet-header">1/10 (tick)</td>
                            <td>
                                <div class="sheet-field">
                                    <span class="sheet-field" name="attr_hpMarker_1_10">0</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-header">25%</td>
                            <td>
                                <div class="sheet-field">
                                    <span class="sheet-field" name="attr_hpMarker_1_4">0</span>
                                </div>
                            </td>
                            <td class="sheet-header">1/16</td>
                            <td>
                                <div class="sheet-field">
                                    <span class="sheet-field" name="attr_hpMarker_1_16">0</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Conditions -->
            <div class="sheet-item">
                <table class="sheet-conditions">
                    <tbody>
                        <tr class="sheet-header">
                            <th colspan="2">Conditions</th>
                        </tr>
                        <tr class="sheet-header">
                            <th colspan="2">Persistent Conditions</th>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_burned" />
                                <span> Burned</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_frozen" />
                                <span> Frozen</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_paralysis" />
                                <span> Paralysis</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_poisoned" />
                                <span> Poisoned</span>
                            </td>
                        </tr>
                        <tr class="sheet-header">
                            <th colspan="2">Volatile Conditions</th>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_badSleep" />
                                <span> Bad Sleep</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_confused" />
                                <span> Confused</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_cursed" />
                                <span> Cursed</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_disabled" />
                                <span> Disabled</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_rage" />
                                <span> Rage</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_flinch" />
                                <span> Flinch</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_infatuation" />
                                <span> Infatuation</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_sleep" />
                                <span> Sleep</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_suppressed" />
                                <span> Suppressed</span>
                            </td>
                            <td>
                                
                            </td>
                        </tr>
                        <tr class="sheet-header">
                            <th colspan="2">Other Conditions</th>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_fainted" />
                                <span> Fainted</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_slowed" />
                                <span> Slowed</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_blindness" />
                                <span> Blindness</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_blindnessTotal" />
                                <span> Total Blindness</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_stuck" />
                                <span> Stuck</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_trapped" />
                                <span> Trapped</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_tripped" />
                                <span> Tripped</span>
                            </td>
                            <td class="sheet-condition-btn">
                                <input type="checkbox" name="attr_condition_vulnerable" />
                                <span> Vulnerable</span>
                            </td>
                        </tr>
                        <tr class="sheet-header">
                            <th colspan="2">Custom Conditions</th>
                        </tr>
                    </tbody>
                </table>
                
                <fieldset class="repeating_conditions">
                    <div class="sheet-condition-item">
                        <input type="checkbox" name="cState"/>
                        <input type="text" name="cCondition" placeholder="Condition" />
                    </div>
                </fieldset>
            </div>
            
        </div>
        
    </div>
    
    <!-- (1) Skills -->
    <div class="sheet-page-skills" >
        
    </div>
    
    <!-- (2) Features -->
    <div class="sheet-page-features" >
        
    </div>
    
    <!-- (3) Moves -->
    <div class="sheet-page-moves" >
        
        <div class="sheet-row sheet-header">
            <span style="margin-right:20px">
                <input type="hidden" name="attr_generic_DB_Roll" value="1d6+1" />
                <label style="display:inline">DB:</label><input type="number" name="attr_generic_DB_Roll" />
                <span class="sheet-generic-damage" name="attr_generic_DB_Roll"> 16d+1</span>
                <button type="roll" name="roll_DB">Damage</button>
            </span>
            <button type="roll" >Accuracy</button>
        </div>
        
        <div class="sheet-moveKnown-group">
            <div>
                <span>Move Known </span>
            </div>
            <fieldset class="repeating_moveKnown">
                <div class="sheet-moveKnown-item">
                    <div class="sheet-header">
                        
                        <span class="sheet-field" name="attr_mkName">Move Name</span>
                        
                        <span class="sheet-field" name="attr_mkFreq">Frequency</span>
                        
                        <div class="sheet-field">
                            <input type="number" name="attr_mkUses" />
                            <span>Uses</span>
                        </div>
                        
                        
                        <button type="roll"></button>
                        
                    </div>
                    <div class="sheet-body">
                        <div class="sheet-row">
                            <span class="sheet-field" name="attr_mkRange">Range</span>
                            <span class="sheet-field" name="attr_mkAC">2</span>
                            <span class="sheet-field" name="attr_mkCrit">20</span>
                            <button type="roll"></button>
                        </div>
                        <div class="sheet-row">
                            <span class="sheet-field" name="attr_mkDB">4</span>
                            <span class="sheet-field" name="attr_mkDamageRoll">1d6+10</span>
                            <button type="roll"></button>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>
        
        <div class="sheet-moveList-group">
            <div>
                <span>Move List </span>
            </div>
            
            <!---
                Move Large    
            -->
            <fieldset class="repeating_moveList">
                <div class="sheet-moveList-item">
                    <input type="hidden" name="attr_mType" class="sheet-move-type" value="-"/>
                    
                    <div class="sheet-known-swap">
                        <input type="checkbox" name="attr_mKnown" value="1"/>
                        <span></span>
                    </div>
                    
                    <div class="sheet-header sheet-typeColor">
                        <input type="hidden" name="attr_mFreq" class="sheet-move-frequency" />
                        
                        <div class="sheet-field"  style="width:300px">
                            <input type="text" name="attr_mName"  placeholder="Move Name" />
                            <span>Name</span>
                        </div>
                        <div class="sheet-field">
                            <select name="attr_mFreq" value="At-Will">
                                <option selected>At-Will</option>
                                <option>EOT</option>
                                <option>Scene</option>
                                <option>Daily</option>
                                <option>Static</option>
                                <option>Other</option>
                            </select>
                            <span>Frequency</span>
                        </div>
                        <div class="sheet-field sheet-move-uses">
                            <input type="number" name="attr_mUses_max" placeholder="Uses" />
                            <span>Uses</span>
                        </div>
                        <div class="sheet-field">
                            <input type="text" name="attr_mRange" placeholder="6, Target 1" />
                            <span>Range</span>
                        </div>
                        
                        <button type="roll" name="roll_mShow"></button>
                    </div>
                    
                    <div class="sheet-body">
                        <input type="hidden" class="sheet-move-type" name="attr_mType"  value="-"/>
                        
                        
                        <div class="sheet-left sheet-typeColor">
                           
                            <div class="sheet-field sheet-row" style="width:100%">
                                <select name="attr_mType">
                                    <option value="Untyped" selected>-</option>
                                    <option>Normal</option>
                                    <option>Bug</option>
                                    <option>Dark</option>
                                    <option>Dragon</option>
                                    <option>Electric</option>
                                    <option>Fairy</option>
                                    <option>Fighting</option>
                                    <option>Fire</option>
                                    <option>Flying</option>
                                    <option>Ghost</option>
                                    <option>Grass</option>
                                    <option>Ground</option>
                                    <option>Ice</option>
                                    <option>Poison</option>
                                    <option>Psychic</option>
                                    <option>Rock</option>
                                    <option>Steel</option>
                                    <option>Water</option>
                                </select>
                                <span>Type</span>
                            </div>
                            <div class="sheet-field sheet-row" style="width:100%">
                                <select name="attr_mClass" value="Physical">
                                    <option selected>Physical</option>
                                    <option>Special</option>
                                    <option>Status</option>
                                </select>
                                <span>Class</span>
                            </div>
                            <div class="sheet-field sheet-row" style="width:100%">
                                <select name="attr_mContestType">
                                    <option>Tough</option>
                                    <option>Cool</option>
                                    <option>Smart</option>
                                    <option>Beauty</option>
                                    <option>Cool</option>
                                </select>
                                <span>Contest Type</span>
                            </div>
                            <div class="sheet-field sheet-row"  style="width:100%">
                                <input type="text" name="attr_mContestEffect" />
                                <span>Contest Effect</span>
                            </div>
                            
                        </div>
                        <div class="sheet-right">
                            <div class="sheet-row">
                                <div class="sheet-field">
                                    <input type="number" name="attr_mAC" value="2"  />
                                    <span>AC</span>
                                </div>
                                <div class="sheet-field">
                                    <input type="number" name="attr_mAC_Bonus" value="0" />
                                    <span>Bonus</span>
                                </div>
                                <div class="sheet-field" style="margin-left:50px">
                                    <input type="number" name="attr_mCrit" value="20" />
                                    <span>Crit On</span>
                                </div>
                                
                                
                                <button type="roll"></button>
                            </div>
                            <div class="sheet-row">
                                <span class="sheet-move-DB">
                                    <div class="sheet-field">
                                        <input type="hidden" name="DamageRoll" />
                                        <input type="number" name="attr_mDB" value="1" min="1" />
                                        <span>DB</span>
                                    </div>
                                    <span>
                                        <input type="number" name="attr_mDiceCount" value="1" min="0"  />
                                        <strong style="color:white;">D</strong>
                                        <input type="number" name="attr_mDiceType"  value="6" min="0" />
                                        <strong style="color:white;">+</strong>
                                        <input type="number" name="attr_mDiceBonus" value="1" />
                                    </span>
                                </span>
                                <div class="sheet-field" >
                                    <select name="attr_mDamageStat" >
                                        <option value="@{stat_atk}">Attack</option>
                                        <option value="@{stat_spatk}">Sp.Attack</option>
                                        <option value = "0" selected="selected">-</option>
                                    </select>
                                    <span>Damage Stat</span>
                                </div>
                                
                                <div class="sheet-field">
                                    <input type="number" name="attr_mDamageBonus" value="0" />
                                    <span>Bonus</span>
                                </div>
                                
                                <button type="roll"></button>
                            </div>
                            <div class="sheet-row">
                                <div class="sheet-field"  style="width:100%">
                                    <textarea name="attr_mDescr"></textarea>
                                    <span>Description</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </fieldset>
            
        </div>
    </div>
    
    <!-- (4) Inventory -->
    <div class="sheet-page-inventory" >
        
    </div>
    
    
</div>

<script type="text/worker">
    
    const stats = ['hp','atk','def','spatk','spdef','speed','accuracy','evasion','initiative'];
    
    const skills = [
        'acrobatics','athletics','combat','intimidate','stealth','survival',
        'general_edu','medicine_edu','occult_edu','pokemon_edu','technology_edu','guile','perception',
        'charm','command','focus','intuition'
    ];
    
    const natures = {
        cuddly      :['HP','Attack','Salty','Spicy'],
        distracted  :['HP','Defense','Salty','Sour'],
        proud       :['HP','Sp.Attack','Salty','Dry'],
        decisive    :['HP','Sp.Defense','Salty','Bitter'],
        patient     :['HP','Speed','Salty','Sweet'],
        
        desperate   :['Attack','HP','Spicy','Salty'],
        lonely      :['Attack','Defense','Spicy','Sour'],
        adamant     :['Attack','Sp.Attack','Spicy','Dry'],
        naughty     :['Attack','Sp.Defense','Spicy','Bitter'],
        brave       :['Attack','Speed','Spicy','Sweet'],
        
        stark       :['Defense','HP','Sour','Salty'],
        bold        :['Defense','Attack','Sour','Spicy'],
        impish      :['Defense','Sp.Attack','Sour','Dry'],
        lax         :['Defense','Sp.Defense','Sour','Bitter'],
        relaxed     :['Defense','Speed','Sour','Sweet'],
        
        curious     :['Sp.Attack','HP','Dry','Salty'],
        modest      :['Sp.Attack','Attack','Dry','Spicy'],
        mild        :['Sp.Attack','Defense','Dry','Sour'],
        rash        :['Sp.Attack','Sp.Defense','Dry','Bitter'],
        quiet       :['Sp.Attack','Speed','Dry','Sweet'],
        
        dreamy      :['Sp.Defense','HP','Bitter','Salty'],
        calm        :['Sp.Defense','Attack','Bitter','Spicy'],
        gentle      :['Sp.Defense','Defense','Bitter','Sour'],
        careful     :['Sp.Defense','Sp.Attack','Bitter','Dry'],
        sassy       :['Sp.Defense','Speed','Bitter','Sweet'],
        
        skittish    :['Speed','HP','Sweet','Salty'],
        timid       :['Speed','Attack','Sweet','Spicy'],
        hasty       :['Speed','Defense','Sweet','Sour'],
        jolly       :['Speed','Sp.Attack','Sweet','Dry'],
        naive       :['Speed','Sp.Defense','Sweet','Bitter'],
        
        composed    :['HP','HP','None','None'],
        hardy       :['Attack','Attack','None','None'],
        docile      :['Defense','Defense','None','None'],
        bashful     :['Sp.Attack','Sp.Attack','None','None'],
        quirky      :['Sp.Defense','Sp.Defense','None','None'],
        serious     :['Speed','Speed','None','None']
    };
    
    const exp = [
                0,0,10,20,30,40,50,60,70,80,90,110,135,160,190,220,250,285,320,360,
                400,460,530,600,670,745,820,900,990,1075,1165,1260,1355,1455,
                1555,1660,1770,1880,1995,2110,2230,2355,2480,2610,2740,2875,
                3015,3155,3300,3445,3645,3850,4060,4270,4485,4705,4985,5160,
                5390,5625,5865,6110,6360,6610,6865,7125,7390,7660,7925,8205,
                8485,8770,9060,9350,9645,9945,10250,10560,10870,11185,11505,
                11910,12320,12735,13155,13580,14010,14445,14885,15330,15780,
                16235,16695,17160,17630,18105,18585,19070,19560,20055,20555
    ];
    
    const evasion = {
        physical:"stat_def",
        special: "stat_spdef",
        speed:"stat_speed"
    };
    
    var getSectionIDsOrdered = function (sectionName, callback) {
      'use strict';
      getAttrs([`_reporder_${sectionName}`], function (v) {
        getSectionIDs(sectionName, function (idArray) {
          let reporderArray = v[`_reporder_${sectionName}`] ? v[`_reporder_${sectionName}`].toLowerCase().split(',') : [],
            ids = [...new Set(reporderArray.filter(x => idArray.includes(x)).concat(idArray))];
          callback(ids);
        });
      });
    };
    
    
    //  Reset Tab
    on("change:isTrainer", function(eventInfo){
        var state = parseInt(eventInfo.newValue) ||0;
        
        setAttrs({
            "tab": 0
        });
    });
    
    // Set Nature Values
    on("change:character_nature sheet:opened", function(eventinfo){
        var update ={};
        var temp = String(eventinfo.newValue).toLowerCase();
        var like = "";
        var dislike = "";
        var raised = "";
        var lowered = "";
        
        if(natures[temp] == null){
            
        }else{
            update["character_raisedStat"]      = natures[temp][0];
            update["character_loweredStat"]     = natures[temp][1];
            update["character_likeFlavor"]      = natures[temp][2];
            update["character_dislikeFlavor"]   = natures[temp][3];
            
            setAttrs(update);
        }
    });
    
    //  Set max EXP
    on("change:level change:isTrainer sheet:opened", function(eventInfo){
        
        getAttrs(["level","isTrainer"],function(values){
            
            var level = parseInt(values["level"], 10) ||0;
            var trainer = String(values["isTrainer"]);
            
            level = Math.max( Math.min( level, 100), 1);
            
            var next = exp[level];
            
            if(trainer == "0" ){
                setAttrs({
                    "exp_max": next
                });
            }else if(trainer == "1" ){
                setAttrs({
                    "exp_max": 10
                });
            }
        });
    });
    
    
    //  Auto-calculate Stats
    stats.forEach( stat => {
        on(`change:stat_${stat}_base change:stat_${stat}_allocated change:stat_${stat}_bonus change:stat_${stat}_stage sheet:opened`, () => {
            
            getAttrs([ `stat_${stat}_base`, `stat_${stat}_allocated`, `stat_${stat}_bonus`, `stat_${stat}_stage` ], values => {
                
                const stat_base = parseInt(values[`stat_${stat}_base`], 10)||0;
                const stat_allocated = parseInt(values[`stat_${stat}_allocated`], 10)||0;
                const stat_bonus = parseInt(values[`stat_${stat}_bonus`], 10)||0;
                const stat_combat = parseInt(values[`stat_${stat}_stage`], 10)||0;
                const stat_score = Math.floor((stat_base + stat_allocated + stat_bonus) * (1 + (0.1 * stat_combat)));
                
                setAttrs({
                    [`stat_${stat}`]: stat_score 
                });
            });
        });
    });
    
    
    //  Auto-Calc Evasions
    Object.keys(evasion).forEach( e => {
        on(`change:evasion_${e}_bonus change:${evasion[e]} change:stat_evasion sheet:opened`, () => {
            
            getAttrs([ `evasion_${e}_bonus`, `${evasion[e]}`, "stat_evasion"], (values) => {
                
                var stat_base = parseInt(values[`${evasion[e]}`], 10)||0;
                var bonus     = parseInt(values[`evasion_${e}_bonus`], 10)||0;
                var ev        = parseInt(values["stat_evasion"], 10)||0;
                
                stat_base = Math.floor(stat_base/5);

                setAttrs({
                    [`evasion_${e}`]: (stat_base + bonus + ev) 
                });
            });
        });
    });
    
    // Auto-Calc Max HP
    on("change:stat_hp change:level change:injury change:isTrainer", function(eventInfo){
        
        getAttrs(["stat_hp", "level", "injury", "isTrainer"], function(values){
            
            var trainer = String(values["isTrainer"]);
            var hp = parseInt(values["stat_hp"])||0;
            var level = parseInt(values["level"])||0 ;
            var injury = parseInt(values["injury"])||0 ;
            
            //Trainers Level x 2 + (HP x 3) +10
            //Pokmon Level + (HP x3) + 10
            var max =  10;
            
            if(trainer == "0"){
                max = (2*level) + (3*hp) +10;
            }else if(trainer == "1"){
                max = (level) + (3*hp) +10;
            }
            
            max = Math.floor(max);
            
            setAttrs({
                "HP_max": max,
                "HP_max_current": Math.floor(max - (max * (0.1 * injury))),
                "hpMarker_3_4": Math.floor(3*max/4),
                "hpMarker_1_2": Math.floor(max/2),
                "hpMarker_1_3": Math.floor(max/3),
                "hpMarker_1_4": Math.floor(max/4),
                "hpMarker_1_6": Math.floor(max/6),
                "hpMarker_1_8": Math.floor(max/8),
                "hpMarker_1_10": Math.floor(max/10),
                "hpMarker_1_16": Math.floor(max/16)
            });
        });
        
    });
    
    
    //  Auto-Calc Capabilities
    on("change:athletics change:acrobatics change:overland_bonus change:swim_bonus change:jumpHigh_bonus change:jumpLong_bonus change:thrown_bonus",function(eventInfo){
        getAttrs(["athletics","acrobatics","overland_bonus","swim_bonus","jumpHigh_bonus","jumpLong_bonus","thrown_bonus"], function(values){
            
            var athl = parseInt(values["athletics"],10)||0;
            var acro = parseInt(values["acrobatics"],10)||0;
            
            var over_b = parseInt(values["overland_bonus"],10)||0;
            var swim_b = parseInt(values["swim_bonus"],10)||0;
            
            var jumph_b = parseInt(values["jumpHigh_bonus"],10)||0;
            var jumpl_b = parseInt(values["jumpLong_bonus"],10)||0;
            
            var thrown_b = parseInt(values["thrown_bonus"],10)||0;
            
            var over = 3 + Math.floor((athl + acro)/2);
            var swim = Math.floor((over + over_b)/2);
            var jumph = 0;
            var jumpl = Math.floor(acro/2);
            var thrown = (4 + athl);
            
            if(acro >= 4){
                jumph += 1;
            }
            if(acro >= 6){
                jumph += 1;
            }
            
            setAttrs({
                "overland": (over + over_b),
                "swim": (swim + swim_b),
                "jumpHigh": (jumph + jumph_b),
                "jumpLong": (jumpl + jumpl_b),
                "thrown": (thrown + thrown_b)
            });
        });
    });
    
    // Calculate AP_max
    on("change:level sheet:opened", function(eventInfo){
        let update = {};
        getAttrs(["level","isTrainer"], function(values){
            var level = parseInt(values["level"], 10)||0;
            var trainer = parseInt(values["isTrainer"], 10)||0;
            
            update["AP_max"] = (5 + Math.floor(level/5));
            
            setAttrs(update);
        });
    });
    
    
    //  Calculate Current AP
    on("change:repeating_AP change:AP_max ", function(eventInfo){
        updateAP();
    });
    
    //  Counts Cost of all AP items, updates Remaining AP
    updateAP = function(){
        let update = {};
        let costTotal = 0;
        let cost_attrs = [];
        let all_attrs = ["AP_max"];
        
        getSectionIDs("repeating_AP", (idarray)=>{
            idarray.forEach( (currentID)=> {
                cost_attrs.push(`repeating_AP_${currentID}_apCost`);
                console.log(`repeating_AP_${currentID}_apCost`);
            });
            
            all_attrs = all_attrs.concat(cost_attrs);
        
            getAttrs(all_attrs, (values)=>{
                let cost = 0;
                let ap_max = parseInt(values["AP_max"])|| 0;
                
                cost_attrs.forEach( (id)=> {
                    cost = cost + (parseInt(values[id],10)||0);
                });
                
                update["AP"]  = ap_max - cost;
                
                setAttrs(update);
                
                console.log(update);
            });
            
        });
        
    };
    
    
    convertDB = function(db){
        let roll ={};
        db = parseInt(db,10)||0;
        var n ,d ,m;
        
        
        // Number of Dice
             if(db< 6){ n = 1;}
        else if(db<10){ n = 2;}
        else if(db<13){ n = 3;}
        else if(db<16){ n = 4;}
        else if(db<18){ n = 5;}
        else if(db<26){ n = 6;}
        else if(db<27){ n = 7;}
        else { n = 8;}
        
        // Die Type
             if(db < 4 || (db>5 && db<8) ){ d = 6;}
        else if((db>3 && db<6) || db==8 || db===10){ d = 8;}
        else if(db==9 || db==11 || (db>12 && db<17) ){ d = 10;}
        else { d = 12;}
        
        // Modifier
             if(db< 2){ m = 1;}
        else if(db< 3){ m = 3;}
        else if(db< 4){ m = 5;}
        else if(db< 5){ m = 6;}
        else if(db< 7){ m = 8;}
        else if(db<14){ m = 10;}
        else if(db<15){ m = 15;}
        else if(db<17){ m = 20;}
        else if(db<19){ m = 25;}
        else if(db<20){ m = 30;}
        else if(db<21){ m = 35;}
        else if(db<22){ m = 40;}
        else if(db<23){ m = 45;}
        else if(db<24){ m = 50;}
        else if(db<25){ m = 55;}
        else if(db<26){ m = 60;}
        else if(db<27){ m = 65;}
        else if(db<28){ m = 70;}
        else { m = 80;}
        
        roll["diceCount"] = n;
        roll["diceType"] = d;
        roll["diceBonus"] = m;
        
        return roll;
    };
    
    on("change:repeating_moveList:mDB",function(eventInfo){
        let update= {};
        var db = parseInt(eventInfo.newValue,10)||0;
        
        roll = convertDB(db);
        
        update["repeating_moveList_mDiceCount"] = roll["diceCount"];
        update["repeating_moveList_mDiceType"]  = roll["diceType"];
        update["repeating_moveList_mDiceBonus"] = roll["diceBonus"];
        update["repeating_moveList_mDiceRoll"]  = `${roll["diceCount"]}d${roll["diceType"]} + ${roll["diceBonus"]}`;
        setAttrs(update);
    });
    
    on("change:repeating_moveList:mDiceCount change:repeating_moveList:mDiceType  change:repeating_moveList:mDiceBonus ", ()=>{
        var update = {};
        var attrList = [
            "repeating_moveList_mDiceCount", "repeating_moveList_mDiceType", "repeating_moveList_mDiceBonus",
            "repeating_moveList_mDamageStat","repeating_moveList_mSTAB"
        ];
        getAttrs(attrList,(values)=>{
            
            var n = parseInt("repeating_moveList_mDiceCount") ||0;
            var d = parseInt("repeating_moveList_mDiceType") ||0;
            var b = parseInt("repeating_moveList_mDiceBonus") ||0;
            
            var dstat = parseInt("repeating_moveList_mDamageStat") ||0;
            var stab  = parseInt("repeating_moveList_mSTAB")||0;
            
            
            
            update["change:repeating_moveList_mDamageRoll"] = ``;
            
            setAttrs(update);
        })
    });
    
    // Update Move Summary
    on("change:repeating_moveList:mKnown", function(eventInfo){
       let update = {};
       let attrList=[
            "repeating_moveList_mName",
            "repeating_moveList_mType",
            "repeating_moveList_mFreq",
            "repeating_moveList_mUses_max",
            "repeating_moveList_mClass",
            "repeating_moveList_mRange",
            "repeating_moveList_mAC",
            "repeating_moveList_mDB",
            "repeating_moveList_mDamageStat",
            "repeating_moveList_mDamageRoll",
            "repeating_moveList_mContestType",
            "repeating_moveList_mContestEffect",
            "repeating_moveList_mDescr"
        ];
        
        var known = parseInt(eventInfo.newValue, 10) || 0;
        var id= "";

       
        if(known == 1){
            console.log("Make new Row");
            // Create new movesKnown row store Row Id in mID
            id = generateRowID();
            var sourceID = eventInfo.sourceAttribute.substring(19,39);
            
            
            getAttrs(attrList,function(values){
                update["repeating_moveKnown_" + id + "_mkID"]            = sourceID;
                update["repeating_moveList_mID"]                         = id;
                update["repeating_moveKnown_" + id + "_mkName"]          = String(values["repeating_moveList_mName"]) ;
                update["repeating_moveKnown_" + id + "_mkFreq"]          = String(values["repeating_moveList_mFreq"]);
                update["repeating_moveKnown_" + id + "_mkUses_max"]      = parseInt(values["repeating_moveList_mUses_max"] ,10) || 0;
                update["repeating_moveKnown_" + id + "_mkType"]          = String(values["repeating_moveList_mType"]);
                update["repeating_moveKnown_" + id + "_mkClass"]         = String(values["repeating_moveList_mClass"]);
                update["repeating_moveKnown_" + id + "_mkRange"]         = parseInt(values["repeating_moveList_mRange"] ,10) || 0;
                //update["repeating_moveKnown_" + id + "_mkHasAC"]         = parseInt(values["repeating_moveList_mHasAC"] ,10) || 0;
                update["repeating_moveKnown_" + id + "_mkAC"]            = parseInt(values["repeating_moveList_mAC"] ,10) || 0;
                //update["repeating_moveKnown_" + id + "_mkHasDB"]         = parseInt(values["repeating_moveList_mHasDB"] ,10) || 0;
                update["repeating_moveKnown_" + id + "_mkDB"]            = parseInt(values["repeating_moveList_mDB"] ,10) || 0;
                update["repeating_moveKnown_" + id + "_mkDamageStat"]    = String(values["repeating_moveList_mDamageStat"]);
                update["repeating_moveKnown_" + id + "_mkRoll"]          = String(values["repeating_moveList_mDamageRoll"]);
                update["repeating_moveKnown_" + id + "_mkContestType"]   = String(values["repeating_moveList_mContestType"]);
                update["repeating_moveKnown_" + id + "_mkContestEffect"] = String(values["repeating_moveList_mContestEfect"]);
                update["repeating_moveKnown_" + id + "_mkEffects"]       = String(values["repeating_moveList_mDescr"]);
                
                setAttrs(update);
            });
            
        }else if(known == 0){
            console.log("Delete Row");
            getAttrs(["repeating_moveList_mID"], function(values){
                
                id = String(values["repeating_moveList_mID"]);
                
                getSectionIDs("moveKnown", function(idarray) {
                    for(var i=0; i < idarray.length; i++) {
                        //Do something with the IDs
                        console.log(idarray[i].toLowerCase());
                        console.log(id.toLowerCase());
                        
                        if(idarray[i].toLowerCase() == id.toLowerCase()){
                            removeRepeatingRow("repeating_moveKnown_" + idarray[i]);
                            break;
                        }
                    }
                });
                
                update["repeating_moveList_mID"] = "";
        
                setAttrs(update);
            });
        }
        
        
    });
    
    // update summary
    on("change:repeating_moveList", (eventInfo)=>{
        var update = {};
        var attrList=[
            "repeating_moveList_mID",
            "repeating_moveList_mName",
            "repeating_moveList_mType",
            "repeating_moveList_mFreq",
            "repeating_moveList_mUses_max",
            "repeating_moveList_mClass",
            "repeating_moveList_mRange",
            "repeating_moveList_mCrit",
            "repeating_moveList_mAC",
            "repeating_moveList_mDB",
            "repeating_moveList_mDamageStat",
            "repeating_moveList_mDamageRoll",
            "repeating_moveList_mContestType",
            "repeating_moveList_mContestEffect",
            "repeating_moveList_mDescr"
        ];
        
        getAttrs(attrList, (values) => {
            
            var id = String( values["repeating_moveList_mID"]);
            
            getSectionIDs("moveKnown", (idarray) =>{
                
                for(var i=0; i < idarray.length; i++) {
                    
                    if(idarray[i].toLowerCase() == id.toLowerCase()){
                        
                        
                        update[`repeating_moveKnown_${id}_mkName`]           = String(values["repeating_moveList_mName"]);
                        update[`repeating_moveKnown_${id}_mkType`]           = String(values["repeating_moveList_mType"]);
                        update[`repeating_moveKnown_${id}_mkFreq`]           = String(values["repeating_moveList_mFreq"]);
                        update[`repeating_moveKnown_${id}_mkUses_max`]       = parseInt(values["repeating_moveList_mUses_max"])||0;
                        update[`repeating_moveKnown_${id}_mkClass`]          = String(values["repeating_moveList_mClass"]);
                        update[`repeating_moveKnown_${id}_mkRange`]          = String(values["repeating_moveList_mRange"]);
                        update[`repeating_moveKnown_${id}_mkCrit`]           = parseInt(values["repeating_moveList_mCrit"])||0;
                        update[`repeating_moveKnown_${id}_mkAC`]             = parseInt(values["repeating_moveList_mAC"])||0;
                        update[`repeating_moveKnown_${id}_mkDB`]             = parseInt(values["repeating_moveList_mDB"])||0;
                        update[`repeating_moveKnown_${id}_mkDamageStat`]     = String(values["repeating_moveList_mDamageStat"]);
                        update[`repeating_moveKnown_${id}_mkDamageRoll`]     = String(values["repeating_moveList_mDamageRoll"]);
                        update[`repeating_moveKnown_${id}_mkContestType`]    = String(values["repeating_moveList_mContestType"]);
                        update[`repeating_moveKnown_${id}_mkContestEffect`]  = String(values["repeating_moveList_mContestEffect"]);
                        update[`repeating_moveKnown_${id}_mkDescr`]          = String(values["repeating_moveList_mDescr"]);
                        
                        setAttrs(update);
                    }
                }
            });
            
        });
        
        
    });
    
    
</script>



